{{#section 'css'}}
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.css" />
	<link href="https://vjs.zencdn.net/7.10.2/video-js.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="/assets/styles/course.css">
	<link rel="stylesheet" type="text/css" href="/assets/styles/course_responsive.css">
	<link rel="stylesheet" type="text/css" href="/assets/styles/style.css" />
{{/section}}
{{#section 'js'}}
	<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
	<script src="https://vjs.zencdn.net/7.10.2/video.min.js"></script>
	<script src="/assets/js/course.js"></script>
	<script src="/assets/js/_bonus.js"></script>

	<script>
		$(document).ready(function () {
			if ($('#favList').val()) {
				const lcFavourite = JSON.parse('{{{json lcFavourite}}}');
				const items = $('.item');

				for (item of items) {
					const id = $(item).data("id");
					let ci;
					if (ci = lcFavourite.find(x => x.CourID === id)) {
						const aLike = $(item).find('.course_like');
						aLike.css('color', 'red');
						aLike.attr('data-id', `${ci.FavID}`);
					}
				}
			}

			$('.course_like').on('click', function () {
				let url = '/account/myfavourite/';
				const id = $(this).data("id");
				if (id) {
					url += 'del';
					$('#txtID').val(id);

				} else {
					url += 'add';
					const CourID = $(this).parents('.item').data("id");
					$('#txtID').val(CourID);
				}

				$('#frmFavour').attr('action', url);
				$('#frmFavour').submit();
			});

			function flyTo(button) {
				const cart = $('.fa-shopping-cart');
				const imgtodrag = $(button).parents('.item').find('.course_image_small').children("img");
				if (imgtodrag) {
					const imgclone = imgtodrag.clone()
						.offset({
							top: imgtodrag.offset().top,
							left: imgtodrag.offset().left
						})
						.css({
							'opacity': '0.5',
							'position': 'absolute',
							'height': '150px',
							'width': '150px',
							'z-index': '100'
						})
						.appendTo($('body'))
						.animate({
							'top': cart.offset().top + 10,
							'left': cart.offset().left + 10,
							'width': 75,
							'height': 75
						}, 1000, 'easeInOutExpo');

					setTimeout(function () {
						cart.effect("shake", {
							times: 2
						}, 200);
					}, 1500);

					imgclone.animate({
						'width': 0,
						'height': 0
					}, function () {
						$(this).detach()
					});
				}
			}

			$('.btnAddCart').on('click', function (e) {
				e.preventDefault();
				if ($('#userId').val() === "") {
					window.location.href = '/account/login';
				} else {
					const id = $(this).data('id');
					const btn = this;
					$.getJSON(`/cart/is-bought?courID=${id}`, function (data) {
						if (data !== false) {
							alert("Bạn đã mua khóa học này!");
							return;
						} else {
							flyTo(btn);
							$.ajax({
								global: false,
								type: 'POST',
								url: '/cart/add', // missing quotes  
								dataType: 'html',
								data: {
									id: id,
								},
								success: function (result) {
									const ret = JSON.parse(result);
									$('.cart-quantity').children('span').html(ret.cartQuantity);
								},
								error: function (request, status, error) {
									serviceError();
								}
							});
						}
					});
				}
			});

			$('.btnBuyNow').on('click', function (e) {
				e.preventDefault();
				if ($('#userId').val() === "")
					window.location.href = '/account/login';
				else {
					const id = $(this).data('id');
					$.getJSON(`/cart/is-bought?courID=${id}`, function (data) {
						if (data !== false) {
							alert("Bạn đã mua khóa học này!");
							return;
						} else {
							$.ajax({
								global: false,
								type: 'POST',
								url: '/cart/add', // missing quotes  
								dataType: 'html',
								data: {
									id: id,
								},
								success: function (result) {
									window.location.href = '/cart';
								},
								error: function (request, status, error) {
									serviceError();
								}
							});
						}
					});
				}
			});
		});
	</script>
{{/section}}
<!-- Home -->
<div class="home">
	<div class="breadcrumbs_container">
		<div class="container">
			<div class="row">
				<div class="col">
					<div class="breadcrumbs">
						<ul>
							<li><a href="/">Trang chủ</a></li>
							<li><a href="/courses">Các khóa học</a></li>
							<li>Chi tiết khóa học</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Course -->
<form id="frmFavour" method="POST" action="">
	<input id="txtID" name="id" type="hidden">
</form>
<form id="frmAddCart" action="/cart/add" method="POST">
	<input type="hidden" name="id" id="txtCourseId">
</form>
<input id="userId" type="hidden" value="{{user.Id}}">
<input id="favList" type="hidden" value="{{lcFavourite}}">
<div class="course">
	<div class="container">
		{{#if empty}}
			<div class="row text-center">
				<h3>Khóa Học Không Tồn Tại</h3>
			</div>
		{{else}}
			<div class="row">
				<!-- Course -->
				<div class="col-lg-8">

					<div class="course_container">
						<div class="course_title">{{course.CourName}}</div>
						<div
							class="course_info d-flex flex-lg-row flex-column align-items-lg-center align-items-start justify-content-start">

							<!-- Course Info Item -->
							<div class="course_info_item">
								<div class="course_info_title">Giảng viên:</div>
								<div class="course_info_text"><a
										href="/teacher/{{course.TeachID}}">{{course.teacher.TeachName}}</a>
								</div>
							</div>

							<!-- Course Info Item -->
							<div class="course_info_item">
								<div class="course_info_title">Đánh giá: {{roundRating course.CourPoint}}</div>
								<div class="star_outer">
									<div class="star_inner" style="width: {{setRatingValue course.CourPoint 64.98}}px;">
									</div>
								</div>
							</div>

							<!-- Course Info Item -->
							<div class="course_info_item">
								<div class="course_info_title">Lĩnh vực:</div>
								<div class="course_info_text"><a href="/category/{{CatID}}">{{course.CatName}}</a>
								</div>
							</div>

							<div class="course_info_item">
								<div class="course_info_title">Lượt xem:</div>
								<div class="course_info_text">{{course.Views}}
								</div>
							</div>

						</div>

						<!-- Course Image -->
						<div class="course_imageBg">
							<img src="/images/courses/{{course.CourImgBg}}" alt="Ảnh khóa học">
						</div>

						<!-- Course Tabs -->
						<div class="course_tabs_container">
							<div class="tabs d-flex flex-row align-items-center justify-content-start">
								<div class="tab active">Thông tin khóa học</div>
								<div class="tab">Giáo trình</div>
								<div class="tab">Giảng viên</div>
								<div class="tab">Đánh giá & Bình luận</div>
							</div>
							<div class="tab_panels">

								<!-- Description -->
								<div class="tab_panel active">

									<div class="tab_panel_title">{{course.CourName}}</div>
									<div class="tab_panel_content">
										<div class="tab_panel_text">
											{{{course.CourDesFull}}}
										</div>

									</div>
								</div>

								<!-- Curriculum -->
								<div class="tab_panel tab_panel_2">
									<div class="tab_panel_content">
										<div class="tab_panel_content">
											<div class="d-flex justify-content-between">
												<h6>Trạng thái: {{#eq course.Finish 1}}Đã hoàn thành{{/eq}}
														{{#eq course.Finish 0}}Đang cập nhật{{/eq}}</h6>
												<h6>Lần cập nhật gần đây:&nbsp;{{formatDateTime course.UpdatedAt}}</h6>
											</div>
											<!-- Dropdowns -->
											<ul class="dropdowns">
												{{#each course.chapters}}
													<li class="has_children">
														<div class="dropdown_item">
															<div class="dropdown_item_title"><span>Chương
																	{{ChapSTT}}: </span>{{ChapName}}</div>
														</div>
														<ul>
															{{#each ../this/course.lessons}}

																{{#eq ../this/ChapID ChapID}}

																	<li class="has_children">
																		<div class="dropdown_item">
																			{{#eq ../this/ChapSTT 1}}
																				{{#if LessLink}}
																					<div class="modal fade"
																						id="modal{{LessID}}"
																						tabindex="-1" role="dialog"
																						aria-labelledby="myModalLabel"
																						aria-hidden="true">
																						<div class="modal-dialog modal-lg"
																							role="document">

																							<!--Content-->
																							<div class="modal-content">

																								<!--Body-->
																								<div
																									class="modal-body mb-0 p-0">
																									<video
																										id="my_video_{{LessID}}"
																										class="video-js vjs-default-skin"
																										controls
																										preload="auto"
																										data-setup='{ "asdf": true }'
																										poster="http://video-js.zencoder.com/oceans-clip.png">
																										<source
																											src="/videos/{{CourID}}/{{ChapID}}/{{LessLink}}"
																											type='video/mp4'>

																									</video>
																								</div>
																								<div
																									class="modal-footer justify-content-between">
																									<div
																										class="dropdown_item_title">
																										<span>Bài
																											{{LessSTT}}:
																										</span>
																										{{LessName}}
																									</div>
																									<button
																										type="button"
																										class="btn btn-outline-primary btn-rounded btn-md ml-4"
																										data-dismiss="modal">Close</button>
																								</div>

																							</div>


																						</div>
																					</div>
																				{{/if}}
																			{{/eq}}
																			<div class="dropdown_item_title">
																				<span>Bài
																					{{LessSTT}}:
																				</span>
																				{{LessName}}
																			</div>
																		</div>
																		<ul>
																			{{#eq ../this/ChapSTT 1}}
																				{{#if LessLink}}
																					<a href="#" data-toggle="modal"
																						data-target="#modal{{LessID}}"
																						class="btn btn-primary mt-2"><i
																							class="fa fa-video-camera"></i>
																						Xem
																						video khóa học</a>
																				{{/if}}
																				<div class="dropdown_item_text">
																					{{{LessText}}}
																				</div>
																			{{/eq}}
																		</ul>
																	</li>
																{{/eq}}
															{{/each}}

														</ul>
													</li>
												{{/each}}
											</ul>
										</div>
									</div>
								</div>

								<!-- Teachers -->
								<div class="tab_panel tab_panel_3">
									<div class="tab_panel_title">Giảng viên</div>
									<div class="sidebar_teacher">
										<div
											class="teacher_title_container d-flex flex-row align-items-center justify-content-start">
											<div class="teacher_image"><img
													src="/images/teachers/{{course.teacher.TeachAvatar}}"
													alt="Avatar giảng viên"></div>
											<div class="teacher_title">
												<div class="teacher_name"><a
														href="/teacher/{{course.TeachID}}">{{course.teacher.TeachName}}</a>
												</div>
												<!--<div class="teacher_position">Marketing & Management</div>-->
											</div>
										</div>
										<div class="teacher_meta_container">
											<!-- Teacher Rating -->
											<div
												class="teacher_meta d-flex flex-row align-items-center justify-content-start">
												<div class="teacher_meta_title">Đánh giá:</div>
												<div class="teacher_meta_text ml-auto">
													<span>{{roundRating course.teacher.TeachPoints}}</span><i
														class="fa fa-star" aria-hidden="true"></i>
												</div>
											</div>
											<!-- Teacher Review -->
											<div
												class="teacher_meta d-flex flex-row align-items-center justify-content-start">
												<div class="teacher_meta_title">Số khóa học:</div>
												<div class="teacher_meta_text ml-auto">
													<span>{{course.teacher.TeachCourses}}</span><i class="fa fa-comment"
														aria-hidden="true"></i>
												</div>
											</div>
											<!-- Teacher Quizzes -->
											<div
												class="teacher_meta d-flex flex-row align-items-center justify-content-start">
												<div class="teacher_meta_title">Học viên:</div>
												<div class="teacher_meta_text ml-auto">
													<span>{{course.teacher.TeachStudents}}</span><i class="fa fa-user"
														aria-hidden="true"></i>
												</div>
											</div>
										</div>
										<div class="teacher_info">
											{{{course.teacher.TeachInfo}}}
										</div>
									</div>
								</div>
								<!-- Reviews -->
								<div class="tab_panel tab_panel_4">
									<div class="tab_panel_title">Đánh giá & Bình luận</div>

									<!-- Rating -->
									<div class="review_rating_container">
										<div class="review_rating">
											<div class="review_rating_num">{{roundRating course.CourPoint}}</div>
											<div class="review_rating_stars">
												<div class="star_outer">
													<div class="star_inner"
														style="width:{{setRatingValue course.CourPoint 116}}px;">
													</div>
												</div>
											</div>
											<div class="review_rating_text">({{course.CourRates}} Đánh giá)</div>
										</div>
										<div class="review_rating_bars">
											<ul>
												<li><span>5 Star</span>
													<div class="review_rating_bar">
														<div
															style="width:{{#if course.reviews.p5}}{{course.reviews.p5}}{{else}}0{{/if}}%;">
														</div>
													</div>
												</li>
												<li><span>4 Star</span>
													<div class="review_rating_bar">
														<div
															style="width:{{#if course.reviews.p4}}{{course.reviews.p4}}{{else}}0{{/if}}%;">
														</div>
													</div>
												</li>
												<li><span>3 Star</span>
													<div class="review_rating_bar">
														<div
															style="width:{{#if course.reviews.p3}}{{course.reviews.p3}}{{else}}0{{/if}}%;">
														</div>
													</div>
												</li>
												<li><span>2 Star</span>
													<div class="review_rating_bar">
														<div
															style="width:{{#if course.reviews.p2}}{{course.reviews.p2}}{{else}}0{{/if}}%;">
														</div>
													</div>
												</li>
												<li><span>1 Star</span>
													<div class="review_rating_bar">
														<div
															style="width:{{#if course.reviews.p1}}{{course.reviews.p1}}{{else}}0{{/if}}%;">
														</div>
													</div>
												</li>
											</ul>
										</div>
									</div>

									<!-- Comments -->
									<div class="comments_container">
										<ul class="comments_list">
											{{#each course.comments}}
												<li>
													<div
														class="comment_item d-flex flex-row align-items-start jutify-content-start">
														<div class="comment_image">
															<div><img
																	src="/images/{{#if StdAvatar}}students/{{StdAvatar}}{{else}}no-avatar.png{{/if}}"
																	alt="Avatar">
															</div>
														</div>
														<div class="comment_content">
															<div
																class="comment_title_container d-flex flex-row align-items-center justify-content-start">
																<div class="comment_author"><a href="#">{{StdName}}</a>
																</div>
																<div class="comment_rating">
																	<div class="star_outer">
																		<div class="star_inner"
																			style="width:{{setRatingValue Point 70}}px;">
																		</div>
																	</div>
																	<span
																		class="course_rating">{{roundRating Point}}</span>

																</div>
																<div class="comment_time ml-auto">{{formatDateTime DOP}}
																</div>
															</div>
															<div class="comment_text">
																<p>{{Feedback}}</p>
															</div>
															<div
																class="comment_extras d-flex flex-row align-items-center justify-content-start">
															</div>
														</div>
													</div>
												</li>
											{{/each}}
										</ul>
										<div class="add_comment_container">
											{{#if user}}
												<div class="add_comment_text">Chỉ học viên của khóa học mới có thể bình
													luận. Thanh toán khóa học để bình luận</div>
											{{else}}
												<div class="add_comment_text">Bạn phải đăng nhập<a
														href="/login">&nbsp;đăng
														nhập&nbsp;</a>để đánh giá khóa học.</div>
											{{/if}}
										</div>
									</div>
								</div>


							</div>
						</div>
					</div>
				</div>


				<!-- Course Sidebar -->
				<div class="col-lg-4">
					<div class="sidebar">

						<!-- Feature -->
						<div class="sidebar_section">
							<div class="sidebar_section_title">Thanh toán khóa học</div>
							<div class="sidebar_feature course_checkout_card item" data-id="{{course.CourID}}">
								<!-- Course Image -->
								<div class="course_image_small">
									<img src="/images/courses/{{course.CourImgSm}}" alt="Hình ảnh khóa học">
								</div>
								<!-- Course Price -->
								<div class="d-flex justify-content-between align-items-center">
									<div class="course_price">{{format course.CourPrice}}đ</div>
									<a href="#" class="course_fav_btn course_like"><i class="fa fa-heart"></i></a>
								</div>

								<div class="course_checkout">
									<button data-id="{{course.CourID}}" type="submit" class="btn btn-primary btnBuyNow"
										title="Buy Now" title="Buy Now">Mua Ngay</button>
									<button data-id="{{course.CourID}}" type="submit"
										class="btn btn-outline-primary btnAddCart" title="Add Cart"
										title="addcart-button">Thêm Vào Giỏ Hàng
									</button>

								</div>

							</div>
						</div>


						<!-- Latest Course -->
						<div class="sidebar_section">
							<div class="sidebar_section_title">Các khóa học mới nhất</div>
							<div class="sidebar_latest">

								<!-- Latest Course -->
								<div class="latest d-flex flex-row align-items-start justify-content-start">
									<div class="latest_image">
										<div><img src="/assets/images/latest_1.jpg" alt=""></div>
									</div>
									<div class="latest_content">
										<div class="latest_title"><a href="course.html">How to Design a Logo a Beginners
												Course</a></div>
										<div class="latest_price">Free</div>
									</div>
								</div>

								<!-- Latest Course -->
								<div class="latest d-flex flex-row align-items-start justify-content-start">
									<div class="latest_image">
										<div><img src="/assets/images/latest_2.jpg" alt=""></div>
									</div>
									<div class="latest_content">
										<div class="latest_title"><a href="course.html">Photography for Beginners
												Masterclass</a></div>
										<div class="latest_price">$170</div>
									</div>
								</div>

								<!-- Latest Course -->
								<div class="latest d-flex flex-row align-items-start justify-content-start">
									<div class="latest_image">
										<div><img src="/assets/images/latest_3.jpg" alt=""></div>
									</div>
									<div class="latest_content">
										<div class="latest_title"><a href="course.html">The Secrets of Body Language</a>
										</div>
										<div class="latest_price">$220</div>
									</div>
								</div>

							</div>
						</div>

					</div>
				</div>
			</div>
		{{/if}}
	</div>
</div>
